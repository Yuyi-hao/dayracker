{% extends "base.html" %}

{% block title %}
    Home
{% endblock %}

{% block main %}
<div class="container-fluid p-4">
  <!-- HEADER  -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="fw-bold mb-1">Monthly Summary for {{ context.month.month_name[1] }} - {{ context.year }}</h2>
      <p class="text-muted mb-0">Overview of your personal, work trackers and your diary entries.</p>
    </div>
    <div class="d-flex gap-2">
      <input type="month" class="form-control" id="monthPicker" value="{{ context.year }}-{{ context.month.month_num}}" onchange="window.location = '?date=' + this.value;">
    </div>
  </div>

  <div class="row g-3 mb-4">
    <div class="col-md-2">
      <div class="card summary-card p-3 d-flex align-items-center">
        <div class="metric-label"><span class="fw-semibold">Avg Mood</span></div>
        <div class="metric-value" id="avgMood">

        </div>
        <div class="kpi-bar mt-2 mb-2" id="avgMoodKpiBar"></div>
        <div class="kpi-bar mt-2" id="avgMoodKpiMoodBar"></div>
      </div>
    </div>

    <div class="col-md-2">
      <div class="card summary-card p-3 d-flex">
        <div class="metric-label d-flex justify-content-between align-items-center mb-2">
          <span class="fw-semibold">üíß Avg Water Intake</span>
          <small class="text-muted">Goal 2.5L</small>
        </div>
        <div class="metric-value" id="avgWaterIntake">
          <span class="h4 text-bold">2.1</span>
          <span class="text-muted mb-3">L/day</span>
        </div>
        <div class="progress mb-2">
          <div class="progress-bar" role="progressbar"></div>
        </div>
        <small class="text-muted d-flex justify-content-between align-items-center mb-2">
          <span>84% of goal days met</span>
          <!-- Daily Dots -->
          <div class="d-flex gap-1 flex-wrap">
            <!-- good hydration -->
            <span class="rounded-circle" style="width:10px;height:10px;background:#4dabf7;"></span>
            <!-- low -->
            <span class="rounded-circle" style="width:10px;height:10px;background:#74c0fc;"></span>
            <!-- missed -->
            <span class="rounded-circle" style="width:10px;height:10px;background:#495057;"></span>
          </div>
        </small>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card summary-card p-3">
        <div class="metric-label">Avg Mood</div>
        <div class="metric-value" id="avgMood">3.4</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card summary-card p-3">
        <div class="metric-label">Avg Mood</div>
        <div class="metric-value" id="avgMood">3.4</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="streak-calender">
        <div class="calender-days-label">
          <span class="day-label">Sun</span>
          <span class="day-label">Mon</span>
          <span class="day-label">Tue</span>
          <span class="day-label">Wed</span>
          <span class="day-label">Thu</span>
          <span class="day-label">Fri</span>
          <span class="day-label">Sat</span>
        </div>
        <div id="streakCalenderGrid"></div>
      </div>
    </div>

  </div>

</div>

<script>
  function renderStreakCalender(year, month, activeDays=[3, 4, 5, 6]){
    const grid = document.getElementById('streakCalenderGrid');
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month+1, 0).getDate();
    grid.innerHTML = "";

    // skip cells in start of month
    for(let i=0; i<firstDay; i++){
      const empty = document.createElement('div');
      empty.className = 'day-cell inactive';
      grid.appendChild(empty);
    }
    
    for(let day=1; day<=daysInMonth; day++){
      const cell = document.createElement('div');
      cell.className = 'day-cell';
      cell.innerText = day;
      if(activeDays.includes(day)){
        const dot = document.createElement('div');
        dot.className = 'dot-success';
        cell.appendChild(dot);
      }
      grid.appendChild(cell);
    }
  }

  renderStreakCalender({{ context.year }}, {{ context.month.month_num }});

  const moodDataCategory = {
    0: {mood:'None'     , emoji:'‚ö™', color:`#6c757d`},
    1: {mood:'Bad'      , emoji:'üòû', color:`#dc3545` },
    2: {mood:'Not good' , emoji:'üòï', color:`#fd7e14` },
    3: {mood:'Neutral'  , emoji:'üòê', color:`#adb5bd` },
    4: {mood:'Good'     , emoji:'üôÇ', color:`#20c997` },
    5: {mood:'Amazing'  , emoji:'üòÑ', color:`#0d6efd` }
  };

  function renderMoodKpiBar(data, averageVal){
    document.getElementById('avgMood').innerHTML = `<span class="h4 text-bold">${averageVal}</span>
          <span class="text-muted mb-3">${moodDataCategory[Math.round(averageVal)%6].emoji}</span>`;
    let total = data.reduce((x, y) => x + y, 0);
    const kpiBar = document.getElementById('avgMoodKpiBar');
    const kpiBarMood = document.getElementById('avgMoodKpiMoodBar');
    for(let i=0; i<6; i++){
      if(data[i] <= 0) continue;
      const bar = document.createElement('div');
      bar.style.background = moodDataCategory[i].color;
      bar.style.width = `${Math.floor(100*(data[i]/total))}%`;
      bar.style.height = `100%`;
      bar.title = moodDataCategory[i].mood;
      kpiBar.appendChild(bar);
      const moodVal = document.createElement('div');
      moodVal.innerText = moodDataCategory[i].emoji;
      moodVal.style.width = `${Math.floor(100*(data[i]/total))}%`;
      moodVal.style.height = `100%`;
      moodVal.style.textAlign = `center`;
      moodVal.title = moodDataCategory[i].mood;
      kpiBarMood.appendChild(moodVal);
    }
  }

  renderMoodKpiBar([2, 3, 4, 5, 8, 9], 5);


</script>



<div class="py-6 px-3 mt-2">
  <div class="row">
    <!-- LEFT SIDE: CHARTS AND SUMMARY  -->
    <div class="col-md-8 col-lg-9 border-end">

      <!-- personal exercise, mood, outgoing  -->
      <div class="row mb-2">
        <div class="card">
          <div class="card-header">
            Mood
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-4 col-lg-4">
                <div class="card chart-card">
                  <div class="card-header">Mood Calendar</div>
                  <div class="card-body">
                    <div class="mood-grid">
                      {% for mood in context.personal_trackers_data_compute.mood %}
                        <div class="mood-cell mood-{{ mood }}">
                          {{ ['üòû','üòï','üòê','üôÇ','üòÄ'][mood-1] }}
                        </div>
                      {% endfor %}
                    </div>
                  </div>
                </div>
              </div>

              <div class="col-md-8 col-lg-8">
                <div class="card">
                  <div class="card-header">
                    Daily Activity
                  </div>
                  <div class="card-body">
                    <canvas id="dailyActivityChart"></canvas>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- personal wakeup, sleep and screen time  -->
      <div class="row mb-2">
        <div class="col-md-6 col-lg-6">
          <div class="card chart-card">
            <div class="card-header">
              Sleep Cycle
            </div>
            <div class="card-body">
              <canvas id="sleepCycle"></canvas>
            </div>
          </div>
        </div>
        <div class="col-md-6 col-lg-6">
          <div class="card chart-card">
            <div class="card-header">
              Screen Time
            </div>
            <div class="card-body">
              <canvas id="screenTime"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- work  -->
      <div class="row mb-2">
        <div class="col-md-6 col-lg-6">
          <div class="card chart-card">
            <div class="card-header">
              Office Timing
            </div>
            <div class="card-body">
              <canvas id="officeTiming"></canvas>
            </div>
          </div>
        </div>
        <div class="col-md-6 col-lg-6">
          <div class="card chart-card">
            <div class="card-header">
              Break Time
            </div>
            <div class="card-body">
              <canvas id="breakTime"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- work productivity  -->
      <div class="row mb-2">
        <div class="col-md-9 col-lg-9">
          <div class="card chart-card">
            <div class="card-header">
              Productivity
            </div>
            <div class="card-body">
              <canvas id="productivity"></canvas>
            </div>
          </div>
        </div>
        <div class="col-md-3 col-lg-3">
          <div class="card chart-card">
            <div class="card-header">
              Off Days
            </div>
            <div class="card-body">
              <canvas id="offDays"></canvas>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- RIGHT SIDE: DIARY SUMMARY  -->
    <div class="col-md-4 col-lg-3 border-end" style="max-height: 80vh; overflow-y: auto;">
      <div class="card chart-card">
        <div class="card-header">Diary Entries</div>
        <div class="card-body">
          {% for entry in context.diary_entries %}
            <div class="input-group input-group-sm mb-2">
              <span class="input-group-text">{{ entry.date }}</span>
              <input type="text"
                     class="form-control"
                     value="{{ entry.short_note }}"
                     readonly>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- charts  -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Mood chart  -->
<script>
  const moodChart = document.getElementById('moodChart');

  new Chart(moodChart, {
    type: 'line',
    data: {
      labels: {{ context.personal_trackers_data_compute.date|tojson }},
      datasets: [{
        label: 'Mood',
        data: {{ context.personal_trackers_data_compute.mood }},
        borderColor: '#4dabf7',
        backgroundColor: 'rgba(77,171,247,0.15)',
        fill: true,
        tension: 0.25,
        pointRadius: 3
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      scales: {
        y: {
          min: 1,
          max: 5,
          ticks: {
            stepSize: 1,
            callback: v => ['üòû','üòï','üòê','üôÇ','üòÄ'][v-1]
          }
        }
      },
      plugins: {
        legend: { display: false }
      }
    }
  });
</script>

<!-- Daily Activity chart  -->
<script>
  const dailyActivityChart = document.getElementById('dailyActivityChart');
  // const dailyActivityData = {{ context.personal_trackers_data|safe }}.map(row => ({
  //     date: row.date,  // date
  //     water_intake: row.water_intake,
  //     exercise: row.exercise,
  //     outgoing: row.outgoing,
  //     dailyActivity: row.dailyActivity,
  // }));

  // console.log(dailyActivityData)
  new Chart(dailyActivityChart, {
    type: 'line',
    data: {
      labels: {{ context.personal_trackers_data_compute.date|tojson }},
      datasets:[
        {
          label: 'Water Intake',
          data: {{ context.personal_trackers_data_compute.water_intake }},
          borderWidth: 1,
          tension: 0.3,
        },
        {
          label: 'Exercise',
          data: {{ context.personal_trackers_data_compute.exercise }},
          borderWidth: 1,
          tension: 0.3,
        },
        {
          label: 'Outgoing',
          data: {{ context.personal_trackers_data_compute.outgoing }},
          borderWidth: 1,
          tension: 0.3,
        },
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      scales: {
        y: {
          min: 0,
          max: 6,
          beginAtZero: true,
          ticks:{
            stepSize: 1
          }
        }
      }
    }
  });
</script>

<!-- sleep cycle chart  -->
<script>
  const sleepCycleChart = document.getElementById('sleepCycle');
  new Chart(sleepCycleChart, {
    type: 'line',
    data: {
      labels: {{ context.personal_trackers_data_compute.date|tojson }},
      datasets:[
        {
          label: 'Wake Up',
          data: {{ context.personal_trackers_data_compute.wakeup_time|tojson }},
          borderWidth: 1,
          borderColor: 'rgb(237, 242, 99)'
        },
        {
          label: 'Sleep',
          data: {{ context.personal_trackers_data_compute.sleep_time|tojson }},
          borderWidth: 1,
          borderColor: 'rgb(98, 131, 247)'
        },
      ]
    },
    options: {
      responsive: true,
      // maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: (value) => {
              const h = Math.floor(value / 60);
              const m = value % 60;
              return `${h}:${m.toString().padStart(2,'0')}`;
            }
          }
        }
      }
    }
  });
</script>

<!-- screen time chart  -->
<script>
  const screenTimeChart = document.getElementById('screenTime');
  new Chart(screenTimeChart, {
    type: 'bar',
    data: {
      labels: {{ context.personal_trackers_data_compute.date|tojson }},
      datasets:[
        {
          label: 'Screen Time',
          data: {{ context.personal_trackers_data_compute.screen_time|tojson }},
          borderWidth: 1,
          borderColor: 'rgb(108, 247, 98)',
          fill: true,
          tension: 0.5
        }
      ]
    },
    options: {
      responsive: true,
      // maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true
        }
      }
    }
  });
</script>

<!-- Office Timing  chart  -->
<script>
  const officeTimingChart = document.getElementById('officeTiming');
  new Chart(officeTimingChart, {
    type: 'line',
    data: {
      labels: {{ context.work_trackers_data_compute.date|tojson }},
      datasets:[
        {
          label: 'Wake Up',
          data: {{ context.work_trackers_data_compute.commute_time|tojson }},
          borderWidth: 1,
          borderColor: 'rgb(237, 242, 99)'
        },
        {
          label: 'Sleep',
          data: {{ context.work_trackers_data_compute.return_time|tojson }},
          borderWidth: 1,
          borderColor: 'rgb(98, 131, 247)'
        },
      ]
    },
    options: {
      responsive: true,
      // maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: (value) => {
              const h = Math.floor(value / 60);
              const m = value % 60;
              return `${h}:${m.toString().padStart(2,'0')}`;
            }
          }
        }
      }
    }
  });
</script>

<!--Break Time chart  -->
<script>
  const breakTimeChart = document.getElementById('breakTime');
  new Chart(breakTimeChart, {
    type: 'bar',
    data: {
      labels: {{ context.work_trackers_data_compute.date|tojson }},
      datasets:[
        {
          label: 'Wake Up',
          data: {{ context.work_trackers_data_compute.break_time|tojson }},
          borderWidth: 1,
          borderColor: 'rgb(237, 242, 99)'
        }
      ]
    },
    options: {
      responsive: true,
      // maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: (value) => {
              const h = Math.floor(value / 60);
              const m = value % 60;
              return `${h}:${m.toString().padStart(2,'0')}`;
            }
          }
        }
      }
    }
  });
</script>

<script>
  const productivityChart = document.getElementById('productivity');
  new Chart(productivityChart, {
    type: 'line',
    data: {
      labels: {{ context.work_trackers_data_compute.date|tojson }},
      datasets:[
        {
          label: 'Given Work',
          data: {{ context.work_trackers_data_compute.given_work }},
          borderWidth: 1,
          tension: 0.3,
        },
        {
          label: 'Completed Work',
          data: {{ context.work_trackers_data_compute.completed_work }},
          borderWidth: 1,
          tension: 0.3,
        },
      ]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true,
          ticks:{
            stepSize: 1
          }
        }
      }
    }
  });
</script>

<script>
  const offDaysChart = document.getElementById('offDays');
  new Chart(offDaysChart, {
    type: 'doughnut',
    data: {
      labels: ['Work Days', 'Off Days'],
      datasets:[
        {
          label: 'Work Days',
          data: [{{ context.work_trackers_data_compute.total_days-context.work_trackers_data_compute.off_days }}, {{ context.work_trackers_data_compute.total_days }}],
          borderWidth: 1,
          tension: 0.3,
        },
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      scales: {
        y: {
          min: 0,
          max: 6,
          beginAtZero: true,
          ticks:{
            stepSize: 1
          }
        }
      }
    }
  });
</script>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="https://netdna.bootstrapcdn.com/bootstrap/2.3.2/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.2.0/js/bootstrap-datepicker.min.js"></script>

<script>
  $("#datepicker").datepicker( {
      format: "mm-yyyy",
      startView: "months", 
      minViewMode: "months"
  });
</script>
{% endblock %}